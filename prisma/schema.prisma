// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider =  "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model Submission {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  phone     String?
  altphone  String?
  state     String?
  district  String?
  village   String?
  pincode   String?
  description   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Composite indexes for efficient filtering
  @@index([state, district, village])
  @@index([pincode])
  @@index([email])
  @@index([name])
  @@index([createdAt(sort: Desc)])
  @@index([state])
  @@index([district])
  @@index([village])
  
  // Composite index for common filter combinations
  @@index([state, district])
  @@index([district, village])
  
  @@map("submissions")
}

model Registration {
  id            Int      @id @default(autoincrement())
  name          String
  phone         String
  email         String?
  altPhone      String?
  state         String
  district      String
  village       String
  meetingInfo   String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([phone])
  @@index([state])
  @@index([district])
  @@map("registrations")
}








// Enum to define what level the Prabhari is at
enum PrabhariLevel {
  ZONE
  STATE
  SAMBHAG
  DISTRICT
  TEHSIL
}

// ---------------------------------------------
// ADMINISTRATIVE UNITS
// ---------------------------------------------

model Zone {
  id     String  @id @default(cuid())
  name   String  @unique
  states State[] // A Zone has many States

  // --- ONE-TO-ONE Relationship ---
  // A Zone can have only ONE Prabhari.
  prabhari Prabhari?
}

model State {
  id       String  @id @default(cuid())
  name     String  @unique // State names should be unique

  // --- (MODIFIED) ---
  // A State can optionally belong to one Zone.
  // User will assign this in the "Zone Management" UI.
  zoneId   String?
  zone     Zone?     @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  
  sambhags Sambhag[] // One State has many Sambhags.
  districts District[] // One State has many Districts.

  // --- ONE-TO-ONE Relationship ---
  // A State can have only ONE Prabhari.
  prabhari Prabhari?
}

model Sambhag {
  id        String   @id @default(cuid())
  name      String
  
  // A Sambhag must belong to one State.
  stateId   String
  state     State    @relation(fields: [stateId], references: [id], onDelete: Cascade)
  
  // --- (MODIFIED) ---
  // A Sambhag can contain many Districts.
  districts District[] 

  // --- ONE-TO-ONE Relationship ---
  // A Sambhag can have only ONE Prabhari.
  prabhari Prabhari?

  @@unique([name, stateId])
}

model District {
  id        String   @id @default(cuid())
  name      String
  
  // --- (NEW) ---
  // A District must belong to one State.
  // This is pre-seeded.
  stateId   String
  state     State    @relation(fields: [stateId], references: [id], onDelete: Cascade)

  // --- (MODIFIED) ---
  // A District can optionally belong to one Sambhag.
  // User will assign this in the "Sambhag Management" UI.
  sambhagId String?
  sambhag   Sambhag? @relation(fields: [sambhagId], references: [id], onDelete: SetNull)

  // --- ONE-TO-MANY Relationship ---
  tehsils   Tehsil[]
  prabharis Prabhari[]

  @@unique([name, stateId]) // District name must be unique within its state
}

model Tehsil {
  id         String   @id @default(cuid())
  name       String
  
  // A Tehsil must belong to one District.
  // This is user-created.
  districtId String
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  // --- ONE-TO-MANY Relationship ---
  prabharis  Prabhari[]

  @@unique([name, districtId]) // Tehsil name must be unique within its district
}

// ---------------------------------------------
// UNIFIED PRABHARI MODEL (No changes needed)
// ---------------------------------------------
model Prabhari {
  id    String @id @default(cuid())
  name  String
  phone String @unique 
  email String?

  level PrabhariLevel

  // --- ONE-TO-ONE Relationships ---
  zoneId String? @unique 
  zone   Zone?   @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  stateId String? @unique 
  state   State?  @relation(fields: [stateId], references: [id], onDelete: SetNull)

  sambhagId String? @unique
  sambhag   Sambhag? @relation(fields: [sambhagId], references: [id], onDelete: SetNull)

  // --- ONE-TO-MANY Relationships ---
  districtId String?
  district   District? @relation(fields: [districtId], references: [id], onDelete: SetNull)

  tehsilId String?
  tehsil   Tehsil?   @relation(fields: [tehsilId], references: [id], onDelete: SetNull)

  @@index([districtId])
  @@index([tehsilId])
}